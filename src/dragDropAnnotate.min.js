(()=>{"use strict";
/**
 * DragDropAnnotate
 * https://github.com/AntoninoBonanno/DragDropAnnotate
 * @author Bonanno Antonino
 * @version v1.1.0
 * @licence LGPL-3.0-or-later
 *
 * jQuery plugin to annotate images easily with drag and drop.
 * DragDropAnnotate is a lightweight image annotation tool that make it easy to add custom markers, comments, hotspots to images via drag and drop.
 * Supports rectangle, and image annotations. The drag and drop functionality based on jQuery UI draggable widget.
 */
{var x=jQuery;const w={MOUSE_MOVE_ANNOTATABLE_ITEM:"onMouseMoveOverItem",ANNOTATION_REMOVED:"onAnnotationRemoved",ANNOTATION_CREATED:"onAnnotationCreated",ANNOTATION_UPDATED:"onAnnotationUpdated"},T={DISABLED:"disabled",NO_TEXT:"noText",FULL:"full"};let y=!1,b=!1;function A(t){return{x:t.x,y:t.y}}function t(t){var e=t.changedTouches[0],o=(b=!0,document.createEvent("MouseEvent"));o.initMouseEvent({touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"}[t.type],!0,!0,window,1,e.screenX,e.screenY,e.clientX,e.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(o),y&&(t.preventDefault(),(t=document.elementFromPoint(e.clientX,e.clientY))instanceof HTMLCanvasElement)&&t.dispatchEvent(o)}function r(t,r,i){const a=x('<canvas class="dda-canvas"></canvas>'),s=(t.append(a),new O(this,t,r)),d=new E(t,r);let h=[],c=void 0,o=void 0,n=void 0;const l=a[0].getContext("2d"),u=this,p=(a.droppable({drop:function(t,e){o.geometry.update(g(e.offset.left,e.offset.top)),u.addAnnotation(o),o=void 0},over:function(t,e){e.helper.is(":hidden")||e.helper.hide(),o=new L(e.draggable.attr("annotation-id"),e.draggable[0],e.draggable.attr("annotation-text"),new R(g(e.offset.left,e.offset.top),e.draggable.attr("annotation-width")||e.draggable[0].naturalWidth,e.draggable.attr("annotation-height")||e.draggable[0].naturalHeight,e.draggable.attr("annotation-rotation")),e.draggable.attr("annotation-editable"))},out:function(t,e){e.helper.is(":hidden")&&e.helper.show(),o=void 0,u.redrawAnnotations()}}),a.mousemove(t=>{var t=p(t.offsetX,t.offsetY);i(w.MOUSE_MOVE_ANNOTATABLE_ITEM,A(t)),o?(u.redrawAnnotations(),o.geometry.update(t),m(o)):c?c(t):0===(t=v(t)).length?(n=void 0,a.css("cursor","default"),s.hide(),u.redrawAnnotations()):!s.isHidden()&&n===t[0]||(n!==t[0]&&(n=t[0],d.show&&d.show(r.hint.iconMove,r.hint.messageMove),a.css("cursor","move"),u.redrawAnnotations(n)),s.show(n,f()))}),a.mouseup(()=>{var t;c&&(t=c(),i(w.ANNOTATION_UPDATED,[t.new.print(),t.old_print]),c=void 0),y=!1}),a.mousedown(t=>{if(b&&!y&&(y=!0,t.type="mousemove",a.trigger(t)),n&&!c){b||s.hide(!0);const o=n.print();let e=p(t.offsetX,t.offsetY);e={x:e.x-n.geometry.center.x,y:e.y-n.geometry.center.y},c=function(t){return t&&(t={x:t.x-e.x,y:t.y-e.y},b&&t.x!==n.geometry.center.x&&t.y!==n.geometry.center.y&&s.hide(),n.geometry.update({x:t.x,y:t.y}),u.redrawAnnotations(n)),{new:n,old_print:o}}}}),function(t,e){return{x:parseInt(t/a.width()*a[0].width),y:parseInt(e/a.height()*a[0].height)}}),e=function(t,e){return{x:parseInt(t*a.width()/a[0].width),y:parseInt(e*a.height()/a[0].height)}},g=function(t,e){return p(t-a.offset().left,e-a.offset().top)},f=function(){var t;if(n)return t=n.geometry.getLowerVertex(),e(t.x,t.y)},m=function(o,n=!1){var i=-o.geometry.width/2,a=-o.geometry.height/2;if(l.save(),l.beginPath(),l.translate(o.geometry.center.x,o.geometry.center.y),l.rotate(-o.geometry.rotation*Math.PI/180),o.image&&l.drawImage(o.image,i,a,o.geometry.width,o.geometry.height),!o.image||r.annotationStyle.imageBorder){let t,e;t=n?(e=r.annotationStyle.hiBorderColor,r.annotationStyle.hiBorderSize):(e=r.annotationStyle.borderColor,r.annotationStyle.borderSize),l.lineJoin="round",l.lineWidth=1,l.strokeStyle="#000000",l.strokeRect(.5+i,.5+a,o.geometry.width-1,o.geometry.height-1),l.lineJoin="miter",l.lineWidth=t,l.strokeStyle=e,l.strokeRect(1+i+t/2,1+a+t/2,o.geometry.width-2-t,o.geometry.height-2-t)}l.restore()},v=function(e){let o=[];return h.forEach(t=>{t.geometry.intersect(e.x,e.y)&&o.push(t)}),o=o.reverse()};this.resize=function(t,e){a[0].width=t,a[0].height=e},this.clear=function(){l.clearRect(0,0,a[0].width,a[0].height)},this.redrawAnnotations=function(o=void 0){u.clear();let n=void 0;h.forEach(t=>{var e=!!o&&(o instanceof Object?t===o:t.id===o);e&&r.annotationStyle.foreground?(n&&m(n,!0),n=t):m(t,e)}),n&&m(n,!0)},this.getAnnotations=function(){return h},this.addAnnotation=function(o,t=void 0,n=!0){if(t)-1<(t=h.indexOf(t))&&(h[t]=o,u.redrawAnnotations());else{let e=!0;for(let t=0;t<h.length;t++)if(h[t].geometry.area<o.geometry.area){h.splice(t,0,o),e=!1;break}e&&h.push(o),m(o),n&&i(w.ANNOTATION_CREATED,[o.print()])}},this.startRotateAnnotation=function(o){if(o.editable!==T.DISABLED){s.hide(!0),d.show&&d.show(r.hint.iconRotate,r.hint.messageRotate),a.css("cursor","default");const n=o.print();let e;c=function(t){return t&&(t=180*Math.atan2(t.y-o.geometry.center.y,t.x-o.geometry.center.x)/Math.PI,o.geometry.update(void 0,o.geometry.rotation+(e-t)),e=t,u.redrawAnnotations(o)),{new:o,old_print:n}}}},this.removeAnnotation=function(t,e=!0){t.editable!==T.DISABLED&&(s.hide(!0),h.splice(h.indexOf(t),1),e&&i(w.ANNOTATION_REMOVED,[t.print()]),u.redrawAnnotations())},this.removeAll=function(e=void 0){e?(h=h.filter(t=>t.id!==e),u.redrawAnnotations()):(h=[],u.clear())},this.editTextAnnotation=function(t,e,o=!0){var n;t.editable===T.FULL&&(n=t.print(),t.text=e,o)&&i(w.ANNOTATION_UPDATED,[t.print(),n])}}function s(t,e){function n(t,e,o){o=o?a(o):void 0,i.addAnnotation(new L(t.id,e,t.text,new R(t.position.center,t.width||e.naturalWidth,t.height||e.naturalHeight,t.rotation),t.editable),o,!1)}this.image=t instanceof x?t:x(t),!this.image[0]instanceof Image&&x.error("Annotable it must be an image."),this.image.wrap(x('<div class="dda-annotationlayer"></div>'));const o=this,i=new r(this.image.parent(),e,function(t,e){o.image.trigger(t,e)}),a=(this.image[0].complete?i.resize(this.image[0].naturalWidth,this.image[0].naturalHeight):this.image[0].onload=function(){i.resize(this.naturalWidth,this.naturalHeight)},function(e){var t=i.getAnnotations().find(t=>t.isEqualPrint(e));return t||x.error("Annotation not found."),t});this.addAnnotation=function(t,e=void 0){var o;t.position&&t.position.center&&t.position.center.x&&t.position.center.y||x.error("Invalid annotation."),t.image?t.image instanceof Image?n(t,t.image,e):((!t.image instanceof String||!t.image.includes("http"))&&x.error("Image must be a URL or an instance of Image."),(o=new Image).src=t.image,o.onload=function(){n(t,this,e)}):n(t,{},e)},this.getAnnotations=function(){const e=[];return i.getAnnotations().forEach(t=>{e.push(t.print())}),e},this.removeAnnotation=function(t){i.removeAnnotation(a(t),!1)},this.removeAll=function(t=void 0){i.removeAll(t)},this.hideAnnotations=function(){i.clear()},this.showAnnotations=function(){i.redrawAnnotations()},this.highlightAnnotation=function(t){i.redrawAnnotations(t instanceof Object?a(t):t)},this.on=function(t,e){this.image.on(t,e)}}document.addEventListener("touchstart",t,{passive:!1}),document.addEventListener("touchmove",t,{passive:!1}),document.addEventListener("touchend",t,{passive:!1}),document.addEventListener("touchcancel",t,{passive:!1});const R=function(t,e=50,o=50,n=0){this.center=t,this.width=e,this.height=o,this.rotation=n,this.area=e*o;let r=void 0;function i(){var t=s.rotation*Math.PI/180,e=Math.sin(t),t=Math.cos(t),o=s.width/2,n=s.height/2,i=o*t,a=n*e,o=o*e,e=n*t;(r={}).topR={x:s.center.x+i-a,y:s.center.y-o-e},r.topL={x:s.center.x-i-a,y:s.center.y+o-e},r.botL={x:s.center.x-i+a,y:s.center.y+o+e},r.botR={x:s.center.x+i+a,y:s.center.y-o+e}}const s=this;this.intersect=function(t,e){r||i();var o=Math.abs(t*r.topL.y-r.topL.x*e+(r.botR.x*e-t*r.botR.y)+(r.topL.x*r.botR.y-r.botR.x*r.topL.y))/2;return(o+=Math.abs(t*r.botR.y-r.botR.x*e+(r.botL.x*e-t*r.botL.y)+(r.botR.x*r.botL.y-r.botL.x*r.botR.y))/2)+Math.abs(t*r.botL.y-r.botL.x*e+(r.topR.x*e-t*r.topR.y)+(r.botL.x*r.topR.y-r.topR.x*r.botL.y))/2+Math.abs(t*r.topR.y-r.topR.x*e+(r.topL.x*e-t*r.topL.y)+(r.topR.x*r.topL.y-r.topL.x*r.topR.y))/2<=s.area},this.getLowerVertex=function(){return r||i(),r.lowerVertex||(r.lowerVertex={x:r.botL.x,y:r.botL.y},Object.keys(r).forEach(t=>{r.lowerVertex.y<r[t].y&&(r.lowerVertex={x:r[t].x,y:r[t].y})})),r.lowerVertex},this.update=function(t,e=void 0){if(t&&(s.center=t),e){for(;360<e;)e-=360;s.rotation=e}r=void 0},this.print=function(){return r||i(),{position:{center:A(s.center),topL:A(r.topL),topR:A(r.topR),botL:A(r.botL),botR:A(r.botR)},rotation:s.rotation,width:e,height:o}}},L=function(t,e,o,n,i=T.NO_TEXT){this.id=t,this.text=o,e instanceof Image&&(this.image=e),this.geometry=n,this.editable=i,this.created_at=Date.now();const a=this;this.print=function(){return{id:a.id,image:a.image?a.image.src:void 0,text:a.text,...a.geometry.print(),editable:a.editable,created_at:a.created_at}},this.isEqualPrint=function(t){return!(!t instanceof Object)&&t.created_at===a.created_at}},E=function(t,e){if(e.hint.enabled){const i=x('<div class="dda-hint-msg dda-opacity-fade" style="opacity: 0;">'+e.hint.message+"</div>"),a=x('<div class="dda-hint-icon">'+e.hint.icon+"</div>");var n=x('<div class="dda-hint"></div>');n.append(i),n.append(a),t.append(n);let o=void 0;const r=this;a.mouseover(()=>{r.show()}),a.mouseout(()=>{r.hide()}),x(e.draggable).mouseover(()=>{r.show()}),this.show=function(t,e){clearTimeout(o),t&&a.html(t),e&&i.html(e),i.css("opacity",1),o=setTimeout(()=>{r.hide()},3e3)},this.hide=function(){clearTimeout(o),i.css("opacity",0),i.html(e.hint.message),a.html(e.hint.icon)}}},O=function(t,e,o){const n=x('<div class="dda-popup-buttons"></div>');var i=x('<button role="button" class="dda-popup-button-rotate" data-toggle="tooltip" title="'+o.popup.tooltipRotate+'">'+o.popup.buttonRotate+"</button>"),a=x('<button role="button" class="dda-popup-button-remove" data-toggle="tooltip" title="'+o.popup.tooltipRemove+'">'+o.popup.buttonRemove+"</button>");n.append(i),n.append(a);const r=x('<div class="dda-popup"></div>').hide(),s=x('<textarea class="dda-popup-textarea" data-toggle="tooltip" title="'+o.popup.tooltipTextarea+'" placeholder = "'+o.popup.placeholderTextarea+'"></textarea>'),d=x('<div class="dda-popup-text" data-toggle="tooltip" title="'+o.popup.tooltipText+'"></div>');r.append(x("<div></div>").append(s)),r.append(d),r.append(n),e.append(r);let h=!1,c=void 0;const l=this;r.mouseover(()=>h=!0),r.mouseout(()=>h=!1),i.click(()=>{t.startRotateAnnotation(c)}),a.click(()=>{t.removeAnnotation(c)}),s.keyup(()=>{t.editTextAnnotation(c,s.val())}),this.show=function(t,e){(c=t).text?d.show().html(c.text):d.hide(),c.editable===T.FULL?(d.hide(),s.show().prop("disabled",!1).removeAttr("style").val(c.text)):s.hide().prop("disabled",!0),c.editable!==T.DISABLED?n.show():n.hide(),r.css({top:e.y,left:e.x}).show()},this.hide=function(t=!1){if(!l.isHidden()&&(b||!h||t)){const e=setTimeout(()=>{!b&&h&&!t||(c=void 0,r.hide()),clearTimeout(e)},300)}},this.isHidden=function(){return r.is(":hidden")}};x.fn.annotable=function(o){let n={},i=void 0;"object"!=typeof o&&o||(n=x.extend(!0,{},x.fn.annotable.defaults,o),i=1<this.length?[]:void 0,x(n.draggable).is(":ui-draggable"))||x(n.draggable).draggable({helper:"clone",ghosting:!0,cursorAt:{top:0,left:0},revert:"invalid",start:function(){y=!0},stop:function(){y=!1}});const a=Array.prototype.slice.call(arguments,1);return this.each(function(){let t=x(this),e=t.data("annotable");if(e){if("string"==typeof o&&e[o])return e[o].apply(e,a);x.error("Method "+o+" does not exist on Annotable")}else n?(e=new s(this,n),t.data("annotable",e),i?i.push(e):i=e):x.error("Annotable is not initialized.")}),i},x.fn.annotable.defaults={draggable:".draggable-annotation",hint:{enabled:!0,message:"Drag and Drop to Annotate",icon:'<i class="far fa-question-circle"></i>',messageMove:"Drag to set new annotation position",iconMove:'<i class="fas fa-info"></i>',messageRotate:"Move to set new annotation rotation",iconRotate:'<i class="fas fa-info"></i>'},popup:{buttonRotate:'<i class="fas fa-sync-alt"></i>',tooltipRotate:"Change the rotation of annotation",buttonRemove:'<i class="fas fa-trash"></i>',tooltipRemove:"Remove the annotation",tooltipText:"Text of annotation",tooltipTextarea:"Text of annotation",placeholderTextarea:"Enter Text"},annotationStyle:{borderColor:"#ffffff",borderSize:2,hiBorderColor:"#fff000",hiBorderSize:2.2,imageBorder:!0,foreground:!0}}}})();