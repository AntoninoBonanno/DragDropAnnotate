/**
 * DragDropAnnotate
 * https://github.com/AntoninoBonanno/DragDropAnnotate
 * @author Bonanno Antonino 
 * 
 * jQuery plugin to annotate images easily with drag and drop.
 * DragDropAnnotate is a lightweight image annotation tool that make it easy to add custom markers, comments, hotspots to images via drag and drop.
 * Supports rectangle, and image annotations. The drag and drop functionality based on jQuery UI draggable widget.
 */
"use strict";!function(t){var e="onMouseMoveOverItem",o="onAnnotationRemoved",n="onAnnotationCreated",i="onAnnotationUpdated",a=!1,r=!1;function s(t){return{x:t.x,y:t.y}}function d(t){var e=t.changedTouches[0];r=!0;var o=document.createEvent("MouseEvent");if(o.initMouseEvent({touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"}[t.type],!0,!0,window,1,e.screenX,e.screenY,e.clientX,e.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(o),a){t.preventDefault();var n=document.elementFromPoint(e.clientX,e.clientY);n instanceof HTMLCanvasElement&&n.dispatchEvent(o)}}document.addEventListener("touchstart",d,{passive:!1}),document.addEventListener("touchmove",d,{passive:!1}),document.addEventListener("touchend",d,{passive:!1}),document.addEventListener("touchcancel",d,{passive:!1});var h=function(t,e=50,o=50,n=0){this.center=t,this.width=e,this.height=o,this.rotation=n,this.area=e*o;var i=void 0,a=this,r=function(){var t=a.rotation*Math.PI/180,e=Math.sin(t),o=Math.cos(t),n=a.width/2,r=a.height/2,s=n*o,d=r*e,h=n*e,c=r*o;(i={}).topR={x:a.center.x+s-d,y:a.center.y-h-c},i.topL={x:a.center.x-s-d,y:a.center.y+h-c},i.botL={x:a.center.x-s+d,y:a.center.y+h+c},i.botR={x:a.center.x+s+d,y:a.center.y-h+c}};this.intersect=function(t,e){i||r();var o=Math.abs(t*i.topL.y-i.topL.x*e+(i.botR.x*e-t*i.botR.y)+(i.topL.x*i.botR.y-i.botR.x*i.topL.y))/2;return o+=Math.abs(t*i.botR.y-i.botR.x*e+(i.botL.x*e-t*i.botL.y)+(i.botR.x*i.botL.y-i.botL.x*i.botR.y))/2,o+=Math.abs(t*i.botL.y-i.botL.x*e+(i.topR.x*e-t*i.topR.y)+(i.botL.x*i.topR.y-i.topR.x*i.botL.y))/2,(o+=Math.abs(t*i.topR.y-i.topR.x*e+(i.topL.x*e-t*i.topL.y)+(i.topR.x*i.topL.y-i.topL.x*i.topR.y))/2)<=a.area},this.getLowerVertex=function(){return i||r(),i.lowerVertex||(i.lowerVertex={x:i.botL.x,y:i.botL.y},Object.keys(i).forEach(t=>{i.lowerVertex.y<i[t].y&&(i.lowerVertex={x:i[t].x,y:i[t].y})})),i.lowerVertex},this.update=function(t,e){if(t&&(a.center=t),e){for(;e>360;)e-=360;a.rotation=e}i=void 0},this.print=function(){return i||r(),{position:{center:s(a.center),topL:s(i.topL),topR:s(i.topR),botL:s(i.botL),botR:s(i.botR)},rotation:a.rotation,width:e,height:o}}},c=function(t,e,o,n,i=!0){this.id=t,this.text=o,e instanceof Image&&(this.image=e),this.geometry=n,this.editable=i,this.created_at=Date.now();var a=this;this.print=function(){return{id:a.id,image:a.image?a.image.src:void 0,text:a.text,...a.geometry.print(),editable:a.editable,created_at:a.created_at}},this.isEqualPrint=function(t){return!(!t instanceof Object)&&t.created_at==a.created_at}},u=function(e,o){if(o.hint.enabled){var n=t('<div class="dda-hint-msg dda-opacity-fade" style="opacity: 0;">'+o.hint.message+"</div>"),i=t('<div class="dda-hint-icon">'+o.hint.icon+"</div>"),a=t('<div class="dda-hint"></div>');a.append(n),a.append(i),e.append(a);var r=void 0,s=this;i.mouseover(()=>{s.show()}),i.mouseout(()=>{s.hide()}),t(o.draggable).mouseover(()=>{s.show()}),this.show=function(t,e){clearTimeout(r),t&&i.html(t),e&&n.html(e),n.css("opacity",1),r=setTimeout(()=>{s.hide()},3e3)},this.hide=function(){clearTimeout(r),n.css("opacity",0),n.html(o.hint.message),i.html(o.hint.icon)}}},l=function(e,o,n){var i=t('<div class="dda-popup-buttons"></div>'),a=t('<button role="button" class="dda-popup-button-rotate" data-toggle="tooltip" title="'+n.popup.tooltipRotate+'">'+n.popup.buttonRotate+"</button>"),s=t('<button role="button" class="dda-popup-button-remove" data-toggle="tooltip" title="'+n.popup.tooltipRemove+'">'+n.popup.buttonRemove+"</button>");i.append(a),i.append(s);var d=t('<div class="dda-popup"></div>').hide();d.append(t('<div class="dda-popup-text" data-toggle="tooltip" title="'+n.popup.tooltipText+'"></div>')),d.append(i),o.append(d);var h=!1,c=void 0,u=this;d.mouseover(t=>h=!0),d.mouseout(t=>h=!1),a.click(t=>{c.editable&&e.startRotateAnnotation(c)}),s.click(t=>{c.editable&&e.removeAnnotation(c)}),this.show=function(t,e){(c=t).text?d.children(".dda-popup-text").show().html(c.text):d.children(".dda-popup-text").hide(),c.editable?i.show():i.hide(),d.css({top:e.y,left:e.x}).show()},this.hide=function(t=!1){if(!u.isHidden()&&(r||!h||t))var e=setTimeout(()=>{(r||!h||t)&&(c=void 0,d.hide()),clearTimeout(e)},300)},this.isHidden=function(){return d.is(":hidden")}},p=function(d,p,f){var g=t('<canvas class="dda-canvas"></canvas>');d.append(g);var v=new l(this,d,p),m=new u(d,p),y=[],b=void 0,x=void 0,w=void 0,A=g[0].getContext("2d"),R=this;g.droppable({drop:function(t,e){x.geometry.update(M(e.offset.left,e.offset.top)),R.addAnnotation(x),x=void 0},over:function(t,e){e.helper.is(":hidden")||e.helper.hide(),x=new c(e.draggable.attr("annotation-id"),e.draggable[0],e.draggable.attr("annotation-text"),new h(M(e.offset.left,e.offset.top),e.draggable.attr("annotation-width")||e.draggable[0].naturalWidth,e.draggable.attr("annotation-height")||e.draggable[0].naturalHeight,e.draggable.attr("annotation-rotation"),e.draggable.attr("annotation-editable")))},out:function(t,e){e.helper.is(":hidden")&&e.helper.show(),x=void 0,R.redrawAnnotations()}}),g.mousemove(t=>{var o=L(t.offsetX,t.offsetY);if(f(e,s(o)),x)return R.redrawAnnotations(),x.geometry.update(o),void I(x);if(b)b(o);else{var n=S(o);if(0==n.length)return w=n=void 0,g.css("cursor","default"),v.hide(),void R.redrawAnnotations();(v.isHidden()||w!=n[0])&&(w!=n[0]&&(w=n[0],m.show&&m.show(p.hint.iconMove,p.hint.messageMove),g.css("cursor","move"),R.redrawAnnotations(w)),v.show(w,E()))}}),g.mouseup(t=>{if(b){var e=b();f(i,[e.new.print(),e.old_print]),b=void 0}a=!1}),g.mousedown(t=>{if(r&&!a&&(a=!0,t.type="mousemove",g.trigger(t)),w&&!b){r||v.hide(!0);var e=w.print(),o=L(t.offsetX,t.offsetY);o={x:o.x-w.geometry.center.x,y:o.y-w.geometry.center.y},b=function(t){if(t){var n={x:t.x-o.x,y:t.y-o.y};r&&n.x!=w.geometry.center.x&&n.y!=w.geometry.center.y&&v.hide(),w.geometry.update({x:n.x,y:n.y}),R.redrawAnnotations(w)}return{new:w,old_print:e}}}});var L=function(t,e){return{x:parseInt(t/g.width()*g[0].width),y:parseInt(e/g.height()*g[0].height)}},M=function(t,e){return L(t-g.offset().left,e-g.offset().top)},E=function(){if(w){var t,e,o=w.geometry.getLowerVertex();return t=o.x,e=o.y,{x:parseInt(t*g.width()/g[0].width),y:parseInt(e*g.height()/g[0].height)}}},I=function(t,e=!1){var o,n,i=-t.geometry.width/2,a=-t.geometry.height/2;(A.save(),A.beginPath(),A.translate(t.geometry.center.x,t.geometry.center.y),A.rotate(-t.geometry.rotation*Math.PI/180),t.image&&A.drawImage(t.image,i,a,t.geometry.width,t.geometry.height),!t.image||p.annotationStyle.imageBorder)&&(e?(n=p.annotationStyle.hiBorderColor,o=p.annotationStyle.hiBorderSize):(n=p.annotationStyle.borderColor,o=p.annotationStyle.borderSize),A.lineJoin="round",A.lineWidth=1,A.strokeStyle="#000000",A.strokeRect(i+.5,a+.5,t.geometry.width-1,t.geometry.height-1),A.lineJoin="miter",A.lineWidth=o,A.strokeStyle=n,A.strokeRect(i+1+o/2,a+1+o/2,t.geometry.width-2-o,t.geometry.height-2-o));A.restore()},S=function(t){var e=[];return y.forEach(o=>{o.geometry.intersect(t.x,t.y)&&e.push(o)}),e=e.reverse()};this.resize=function(t,e){g[0].width=t,g[0].height=e},this.clear=function(){A.clearRect(0,0,g[0].width,g[0].height)},this.redrawAnnotations=function(t){R.clear();var e=void 0;y.forEach(o=>{var n=!!t&&(t instanceof Object?o==t:o.id===t);if(n&&p.annotationStyle.foreground)return e&&I(e,!0),void(e=o);I(o,n)}),e&&I(e,!0)},this.getAnnotations=function(){return y},this.addAnnotation=function(t,e,o=!0){if(e){var i=y.indexOf(e);i>-1&&(y[i]=t,R.redrawAnnotations())}else{var a=!0;for(let e=0;e<y.length;e++){if(y[e].geometry.area<t.geometry.area){y.splice(e,0,t),a=!1;break}}a&&y.push(t),I(t),o&&f(n,[t.print()])}},this.startRotateAnnotation=function(t){v.hide(!0),m.show&&m.show(p.hint.iconRotate,p.hint.messageRotate),g.css("cursor","default");var e,o=t.print();b=function(n){if(n){var i=180*Math.atan2(n.y-t.geometry.center.y,n.x-t.geometry.center.x)/Math.PI;t.geometry.update(void 0,t.geometry.rotation+(e-i)),e=i,R.redrawAnnotations(t)}return{new:t,old_print:o}}},this.removeAnnotation=function(t,e=!0){v.hide(!0),y.splice(y.indexOf(t),1),e&&f(o,[t.print()]),R.redrawAnnotations()},this.removeAll=function(t){if(t)return y=y.filter(e=>e.id!==t),void R.redrawAnnotations();y=[],R.clear()}},f=function(e,o){this.image=e instanceof t?e:t(e),!this.image[0]instanceof Image&&t.error("Annotable it must be an image."),this.image.wrap(t('<div class="dda-annotationlayer"></div>'));var n=this,i=new p(this.image.parent(),o,function(t,e){n.image.trigger(t,e)});this.image[0].complete?i.resize(this.image[0].naturalWidth,this.image[0].naturalHeight):this.image[0].onload=function(){i.resize(this.naturalWidth,this.naturalHeight)};var a=function(t,e,o){var n=o?r(o):void 0;i.addAnnotation(new c(t.id,e,t.text,new h(t.position.center,t.width||e.naturalWidth,t.height||e.naturalHeight,t.rotation),t.editable),n,!1)},r=function(e){var o=i.getAnnotations().find(t=>t.isEqualPrint(e));return o||t.error("Annotation not found."),o};this.addAnnotation=function(e,o){if(e.position&&e.position.center&&e.position.center.x&&e.position.center.y||t.error("Invalid annotation."),e.image)if(e.image instanceof Image)a(e,e.image,o);else{(!e.image instanceof String||!e.image.includes("http"))&&t.error("Image must be a URL or an instance of Image.");var n=new Image;n.src=e.image,n.onload=function(){a(e,this,o)}}else a(e,{},o)},this.getAnnotations=function(){var t=[];return i.getAnnotations().forEach(e=>{t.push(e.print())}),t},this.removeAnnotation=function(t){i.removeAnnotation(r(t),!1)},this.removeAll=function(t){i.removeAll(t)},this.hideAnnotations=function(){i.clear()},this.showAnnotations=function(){i.redrawAnnotations()},this.highlightAnnotation=function(t){i.redrawAnnotations(t instanceof Object?r(t):t)},this.on=function(t,e){this.image.on(t,e)}};t.fn.annotable=function(e){if("object"==typeof e||!e){var o=t.extend(!0,{},t.fn.annotable.defaults,e),n=this.length>1?[]:void 0;t(o.draggable).is(":ui-draggable")||t(o.draggable).draggable({helper:"clone",ghosting:!0,cursorAt:{top:0,left:0},revert:"invalid",start:function(){a=!0},stop:function(){a=!1}})}var i=Array.prototype.slice.call(arguments,1);return this.each(function(){var a=t(this),r=a.data("annotable");if(r){if("string"==typeof e&&r[e])return r[e].apply(r,i);t.error("Method "+e+" does not exist on Annotable")}else o?(r=new f(this,o),a.data("annotable",r),n?n.push(r):n=r):t.error("Annotable is not initialized.")}),n},t.fn.annotable.defaults={draggable:".draggable-annotation",hint:{enabled:!0,message:"Drag and Drop to Annotate",icon:'<i class="far fa-question-circle"></i>',messageMove:"Drag to set new annotation position",iconMove:'<i class="fas fa-info"></i>',messageRotate:"Move to set new annotation rotation",iconRotate:'<i class="fas fa-info"></i>'},popup:{buttonRotate:'<i class="fas fa-sync-alt"></i>',tooltipRotate:"Change the rotation of annotation",buttonRemove:'<i class="fas fa-trash"></i>',tooltipRemove:"Remove the annotation",tooltipText:"Text of annotation"},annotationStyle:{borderColor:"#ffffff",borderSize:2,hiBorderColor:"#fff000",hiBorderSize:2.2,imageBorder:!0,foreground:!0}}}(jQuery);